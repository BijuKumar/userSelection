"use strict";angular.module("mentio",[]).directive("mentio",["mentioUtil","$document","$compile","$log","$timeout",function(e,t,n,r,i){return{restrict:"A",scope:{macros:"=mentioMacros",search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",typedTerm:"=mentioTypedTerm",altId:"=mentioId",iframeElement:"=mentioIframeElement",requireLeadingSpace:"=mentioRequireLeadingSpace",selectNotFound:"=mentioSelectNotFound",trimTerm:"=mentioTrimTerm",ngModel:"="},controller:["$scope","$timeout","$attrs",function(n,r,i){n.query=function(e,t){var r=n.triggerCharMap[e];(void 0===n.trimTerm||n.trimTerm)&&(t=t.trim()),r.showMenu(),r.search({term:t}),r.typedTerm=t},n.defaultSearch=function(e){var t=[];angular.forEach(n.items,function(n){n.label.toUpperCase().indexOf(e.term.toUpperCase())>=0&&t.push(n)}),n.localItems=t},n.bridgeSearch=function(e){(i.mentioSearch?n.search:n.defaultSearch)({term:e})},n.defaultSelect=function(e){return n.defaultTriggerChar+e.item.label},n.bridgeSelect=function(e){return(i.mentioSelect?n.select:n.defaultSelect)({item:e})},n.setTriggerText=function(e){n.syncTriggerText&&(n.typedTerm=void 0===n.trimTerm||n.trimTerm?e.trim():e)},n.context=function(){if(n.iframeElement)return{iframe:n.iframeElement}},n.replaceText=function(t,i){if(n.hideAll(),e.replaceTriggerText(n.context(),n.targetElement,n.targetElementPath,n.targetElementSelectedOffset,n.triggerCharSet,t,n.requireLeadingSpace,i),!i&&(n.setTriggerText(""),angular.element(n.targetElement).triggerHandler("change"),n.isContentEditable())){n.contentEditableMenuPasted=!0;var o=r(function(){n.contentEditableMenuPasted=!1},200);n.$on("$destroy",function(){r.cancel(o)})}},n.hideAll=function(){for(var e in n.triggerCharMap)n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].hideMenu()},n.getActiveMenuScope=function(){for(var e in n.triggerCharMap)if(n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].visible)return n.triggerCharMap[e];return null},n.selectActive=function(){for(var e in n.triggerCharMap)n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].visible&&n.triggerCharMap[e].selectActive()},n.isActive=function(){for(var e in n.triggerCharMap)if(n.triggerCharMap.hasOwnProperty(e)&&n.triggerCharMap[e].visible)return!0;return!1},n.isContentEditable=function(){return"INPUT"!==n.targetElement.nodeName&&"TEXTAREA"!==n.targetElement.nodeName},n.replaceMacro=function(t,i){i?e.replaceMacroText(n.context(),n.targetElement,n.targetElementPath,n.targetElementSelectedOffset,n.macros,n.macros[t]):(n.replacingMacro=!0,n.timer=r(function(){e.replaceMacroText(n.context(),n.targetElement,n.targetElementPath,n.targetElementSelectedOffset,n.macros,n.macros[t]),angular.element(n.targetElement).triggerHandler("change"),n.replacingMacro=!1},300),n.$on("$destroy",function(){r.cancel(n.timer)}))},n.addMenu=function(e){e.parentScope&&n.triggerCharMap.hasOwnProperty(e.triggerChar)||(n.triggerCharMap[e.triggerChar]=e,void 0===n.triggerCharSet&&(n.triggerCharSet=[]),n.triggerCharSet.push(e.triggerChar),e.setParent(n))},n.$on("menuCreated",function(e,t){void 0===i.id&&void 0===i.mentioId||(i.id===t.targetElement||void 0!==i.mentioId&&n.altId===t.targetElement)&&n.addMenu(t.scope)}),t.on("click",function(){n.isActive()&&n.$apply(function(){n.hideAll()})}),t.on("keydown keypress paste",function(e){var t=n.getActiveMenuScope();t&&(9!==e.which&&13!==e.which||(e.preventDefault(),t.selectActive()),27===e.which&&(e.preventDefault(),t.$apply(function(){t.hideMenu()})),40===e.which&&(e.preventDefault(),t.$apply(function(){t.activateNextItem()}),t.adjustScroll(1)),38===e.which&&(e.preventDefault(),t.$apply(function(){t.activatePreviousItem()}),t.adjustScroll(-1)),37!==e.which&&39!==e.which||e.preventDefault())})}],link:function(t,o,a){if(t.triggerCharMap={},t.targetElement=o,a.$set("autocomplete","off"),a.mentioItems){t.localItems=[],t.parentScope=t;var l=a.mentioSearch?' mentio-items="items"':' mentio-items="localItems"';t.defaultTriggerChar=a.mentioTriggerChar?t.$eval(a.mentioTriggerChar):"@";var c='<mentio-menu mentio-search="bridgeSearch(term)" mentio-select="bridgeSelect(item)"'+l;a.mentioTemplateUrl&&(c=c+' mentio-template-url="'+a.mentioTemplateUrl+'"'),c=c+" mentio-trigger-char=\"'"+t.defaultTriggerChar+'\'" mentio-parent-scope="parentScope"/>';var s=n(c)(t);o.parent().append(s),t.$on("$destroy",function(){s.remove()})}function m(e){function n(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()}var r=t.getActiveMenuScope();if(r){if(9===e.which||13===e.which)return n(e),r.selectActive(),!1;if(27===e.which)return n(e),r.$apply(function(){r.hideMenu()}),!1;if(40===e.which)return n(e),r.$apply(function(){r.activateNextItem()}),r.adjustScroll(1),!1;if(38===e.which)return n(e),r.$apply(function(){r.activatePreviousItem()}),r.adjustScroll(-1),!1;if(37===e.which||39===e.which)return n(e),!1}}a.mentioTypedTerm&&(t.syncTriggerText=!0),t.$watch("iframeElement",function(e){if(e){var n=e.contentWindow.document;n.addEventListener("click",function(){t.isActive()&&t.$apply(function(){t.hideAll()})}),n.addEventListener("keydown",m,!0),t.$on("$destroy",function(){n.removeEventListener("keydown",m)})}}),t.$watch("ngModel",function(n){if(n&&""!==n||t.isActive())if(void 0!==t.triggerCharSet)if(t.contentEditableMenuPasted)t.contentEditableMenuPasted=!1;else{t.replacingMacro&&(i.cancel(t.timer),t.replacingMacro=!1);var o=t.isActive(),a=t.isContentEditable(),l=e.getTriggerInfo(t.context(),t.triggerCharSet,t.requireLeadingSpace,o);if(void 0!==l&&(!o||o&&(a&&l.mentionTriggerChar===t.currentMentionTriggerChar||!a&&l.mentionPosition===t.currentMentionPosition)))l.mentionSelectedElement&&(t.targetElement=l.mentionSelectedElement,t.targetElementPath=l.mentionSelectedPath,t.targetElementSelectedOffset=l.mentionSelectedOffset),t.setTriggerText(l.mentionText),t.currentMentionPosition=l.mentionPosition,t.currentMentionTriggerChar=l.mentionTriggerChar,t.query(l.mentionTriggerChar,l.mentionText);else{var c=t.typedTerm;t.setTriggerText(""),t.hideAll();var s=e.getMacroMatch(t.context(),t.macros);if(void 0!==s)t.targetElement=s.macroSelectedElement,t.targetElementPath=s.macroSelectedPath,t.targetElementSelectedOffset=s.macroSelectedOffset,t.replaceMacro(s.macroText,s.macroHasTrailingSpace);else if(t.selectNotFound&&c&&""!==c){var m=t.triggerCharMap[t.currentMentionTriggerChar];if(m){var u=m.select({item:{label:c}});"function"==typeof u.then?u.then(t.replaceText):t.replaceText(u,!0)}}}}else r.error("Error, no mentio-items attribute was provided, and no separate mentio-menus were specified.  Nothing to do.")})}}}]).directive("mentioMenu",["mentioUtil","$rootScope","$log","$window","$document",function(e,t,n,r,i){return{restrict:"E",scope:{search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",triggerChar:"=mentioTriggerChar",forElem:"=mentioFor",parentScope:"=mentioParentScope"},templateUrl:function(e,t){return void 0!==t.mentioTemplateUrl?t.mentioTemplateUrl:"mentio-menu.tpl.html"},controller:["$scope",function(e){e.visible=!1,this.activate=e.activate=function(t){e.activeItem=t},this.isActive=e.isActive=function(t){return e.activeItem===t},this.selectItem=e.selectItem=function(t){var n=e.select({item:t});"function"==typeof n.then?n.then(e.parentMentio.replaceText):e.parentMentio.replaceText(n)},e.activateNextItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[(t+1)%e.items.length])},e.activatePreviousItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[0===t?e.items.length-1:t-1])},e.isFirstItemActive=function(){return 0===e.items.indexOf(e.activeItem)},e.isLastItemActive=function(){return e.items.indexOf(e.activeItem)===e.items.length-1},e.selectActive=function(){e.selectItem(e.activeItem)},e.isVisible=function(){return e.visible},e.showMenu=function(){e.visible||(e.requestVisiblePendingSearch=!0)},e.setParent=function(t){e.parentMentio=t,e.targetElement=t.targetElement}}],link:function(o,a){if(a[0].parentNode.removeChild(a[0]),i[0].body.appendChild(a[0]),o.menuElement=a,o.parentScope)o.parentScope.addMenu(o);else{if(!o.forElem)return void n.error("mentio-menu requires a target element in tbe mentio-for attribute");if(!o.triggerChar)return void n.error("mentio-menu requires a trigger char");t.$broadcast("menuCreated",{targetElement:o.forElem,scope:o})}angular.element(r).bind("resize",function(){if(o.isVisible()){var t=[];t.push(o.triggerChar),e.popUnderMention(o.parentMentio.context(),t,a,o.requireLeadingSpace)}}),o.$watch("items",function(e){e&&e.length>0?(o.activate(e[0]),!o.visible&&o.requestVisiblePendingSearch&&(o.visible=!0,o.requestVisiblePendingSearch=!1)):o.hideMenu()}),o.$watch("isVisible()",function(t){if(t){var n=[];n.push(o.triggerChar),e.popUnderMention(o.parentMentio.context(),n,a,o.requireLeadingSpace)}}),o.parentMentio.$on("$destroy",function(){a.remove()}),o.hideMenu=function(){o.visible=!1,a.css("display","none")},o.adjustScroll=function(e){var t=a[0],n=t.querySelector("ul"),r=t.querySelector("[mentio-menu-item].active")||t.querySelector("[data-mentio-menu-item].active");return o.isFirstItemActive()?n.scrollTop=0:o.isLastItemActive()?n.scrollTop=n.scrollHeight:void(1===e?n.scrollTop+=r.offsetHeight:n.scrollTop-=r.offsetHeight)}}}}]).directive("mentioMenuItem",function(){return{restrict:"A",scope:{item:"=mentioMenuItem"},require:"^mentioMenu",link:function(e,t,n,r){e.$watch(function(){return r.isActive(e.item)},function(e){e?t.addClass("active"):t.removeClass("active")}),t.bind("mouseenter",function(){e.$apply(function(){r.activate(e.item)})}),t.bind("click",function(){return r.selectItem(e.item),!1})}}}).filter("unsafe",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("mentioHighlight",function(){return function(e,t,n){if(t){var r=n?'<span class="'+n+'">$&</span>':"<strong>$&</strong>";return(""+e).replace(new RegExp(t.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"gi"),r)}return e}}),angular.module("mentio").factory("mentioUtil",["$window","$location","$anchorScroll","$timeout",function(e,t,n,r){function i(t,n){for(var r,i=n[0];void 0===r||0===r.height;)if(0===(r=i.getBoundingClientRect()).height&&(void 0===(i=i.childNodes[0])||!i.getBoundingClientRect))return;var o=r.top,a=o+r.height;if(o<0)e.scrollTo(0,e.pageYOffset+r.top-0);else if(a>e.innerHeight){var l=e.pageYOffset+r.top-0;l-e.pageYOffset>0&&(l=e.pageYOffset+0);var c=e.pageYOffset-(e.innerHeight-a);c>l&&(c=l),e.scrollTo(0,c)}}function o(e){var t=d(e).activeElement;if(null!==t){var n=t.nodeName,r=t.getAttribute("type");return"INPUT"===n&&"text"===r||"TEXTAREA"===n}return!1}function a(e,t,n,r){var i,o=t;if(n)for(var a=0;a<n.length;a++){if(void 0===(o=o.childNodes[n[a]]))return;for(;o.length<r;)r-=o.length,o=o.nextSibling;0!==o.childNodes.length||o.length||(o=o.previousSibling)}var l=f(e);(i=d(e).createRange()).setStart(o,r),i.setEnd(o,r),i.collapse(!0);try{l.removeAllRanges()}catch(e){}l.addRange(i),t.focus()}function l(e,t,n,r){var i,o;o=f(e),(i=d(e).createRange()).setStart(o.anchorNode,n),i.setEnd(o.anchorNode,r),i.deleteContents();var a=d(e).createElement("div");a.innerHTML=t;for(var l,c,s=d(e).createDocumentFragment();l=a.firstChild;)c=s.appendChild(l);i.insertNode(s),c&&((i=i.cloneRange()).setStartAfter(c),i.collapse(!0),o.removeAllRanges(),o.addRange(i))}function c(e,t,n,r){var i=t.nodeName;"INPUT"===i||"TEXTAREA"===i?t!==d(e).activeElement&&t.focus():a(e,t,n,r)}function s(e,t){if(null===t.parentNode)return 0;for(var n=0;n<t.parentNode.childNodes.length;n++){if(t.parentNode.childNodes[n]===t)return n}}function m(e,t){var n,r,i=[];if(o(e))n=d(e).activeElement;else{var a=u(e);a&&(n=a.selected,i=a.path,r=a.offset)}var l=h(e);if(void 0!==l&&null!==l){var c,s=!1;if(l.length>0&&(" "===l.charAt(l.length-1)||" "===l.charAt(l.length-1))&&(s=!0,l=l.substring(0,l.length-1)),angular.forEach(t,function(e,t){var o=l.toUpperCase().lastIndexOf(t.toUpperCase());if(o>=0&&t.length+o===l.length){var a=o-1;0!==o&&" "!==l.charAt(a)&&" "!==l.charAt(a)||(c={macroPosition:o,macroText:t,macroSelectedElement:n,macroSelectedPath:i,macroSelectedOffset:r,macroHasTrailingSpace:s})}}),c)return c}}function u(e){var t=f(e),n=t.anchorNode,r=[];if(null!=n){for(var i,o=n.contentEditable;null!==n&&"true"!==o;)i=s(0,n),r.push(i),null!==(n=n.parentNode)&&(o=n.contentEditable);return r.reverse(),{selected:n,path:r,offset:t.getRangeAt(0).startOffset}}}function g(e,t,n,r,i){var a,l,c;if(o(e))a=d(e).activeElement;else{var s=u(e);s&&(a=s.selected,l=s.path,c=s.offset)}var m=h(e);if(void 0!==m&&null!==m){var g,f=-1;if(t.forEach(function(e){var t=m.lastIndexOf(e);t>f&&(f=t,g=e)}),f>=0&&(0===f||!n||/[\xA0\s]/g.test(m.substring(f-1,f)))){var p=m.substring(f+1,m.length);g=m.substring(f,f+1);var v=p.substring(0,1),T=p.length>0&&(" "===v||" "===v);if(i&&(p=p.trim()),!T&&(r||!/[\xA0\s]/g.test(p)))return{mentionPosition:f,mentionText:p,mentionSelectedElement:a,mentionSelectedPath:l,mentionSelectedOffset:c,mentionTriggerChar:g}}}}function f(e){return e?e.iframe.contentWindow.getSelection():window.getSelection()}function d(e){return e?e.iframe.contentWindow.document:document}function h(e){var t;if(o(e)){var n=d(e).activeElement,r=n.selectionStart;t=n.value.substring(0,r)}else{var i=f(e).anchorNode;if(null!=i){var a=i.textContent,l=f(e).getRangeAt(0).startOffset;l>=0&&(t=a.substring(0,l))}}return t}function p(e,t){var n,r,i="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),o=f(e),a=o.getRangeAt(0);(r=d(e).createRange()).setStart(o.anchorNode,t),r.setEnd(o.anchorNode,t),r.collapse(!1),(n=d(e).createElement("span")).id=i,n.appendChild(d(e).createTextNode("\ufeff")),r.insertNode(n),o.removeAllRanges(),o.addRange(a);var l={left:0,top:n.offsetHeight};return v(e,n,l),n.parentNode.removeChild(n),l}function v(e,t,n){for(var r=t,i=e?e.iframe:null;r;)n.left+=r.offsetLeft+r.clientLeft,n.top+=r.offsetTop+r.clientTop,!(r=r.offsetParent)&&i&&(r=i,i=null);for(r=t,i=e?e.iframe:null;r!==d().body;)r.scrollTop&&r.scrollTop>0&&(n.top-=r.scrollTop),r.scrollLeft&&r.scrollLeft>0&&(n.left-=r.scrollLeft),!(r=r.parentNode)&&i&&(r=i,i=null)}function T(e,t,n){var r=null!==window.mozInnerScreenX,i=d(e).createElement("div");i.id="input-textarea-caret-position-mirror-div",d(e).body.appendChild(i);var o=i.style,a=window.getComputedStyle?getComputedStyle(t):t.currentStyle;o.whiteSpace="pre-wrap","INPUT"!==t.nodeName&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach(function(e){o[e]=a[e]}),r?(o.width=parseInt(a.width)-2+"px",t.scrollHeight>parseInt(a.height)&&(o.overflowY="scroll")):o.overflow="hidden",i.textContent=t.value.substring(0,n),"INPUT"===t.nodeName&&(i.textContent=i.textContent.replace(/\s/g," "));var l=d(e).createElement("span");l.textContent=t.value.substring(n)||".",i.appendChild(l);var c={top:l.offsetTop+parseInt(a.borderTopWidth)+parseInt(a.fontSize),left:l.offsetLeft+parseInt(a.borderLeftWidth)+15};return v(e,t,c),d(e).body.removeChild(i),c}return{popUnderMention:function(t,n,a,l){var c,s=g(t,n,l,!1);if(void 0!==s){c=o(t)?T(t,d(t).activeElement,s.mentionPosition):p(t,s.mentionPosition);var m=window.innerHeight-c.top-15,u=e.pageYOffset;c.top+=u,a.css({top:c.top+"px",left:c.left+"px",position:"absolute",zIndex:1e4,display:"block",overflowY:"auto",maxHeight:m+"px",borderRadius:"4px",border:"1px solid #D1D2D4"}),r(function(){i(0,a)},0)}else a.css({display:"none"})},replaceMacroText:function(e,t,n,r,i,a){c(e,t,n,r);var s=m(e,i);if(s.macroHasTrailingSpace&&(s.macroText=s.macroText+" ",a+=" "),void 0!==s){var u=d(e).activeElement;if(o(e)){var g=s.macroPosition,f=s.macroPosition+s.macroText.length;u.value=u.value.substring(0,g)+a+u.value.substring(f,u.value.length),u.selectionStart=g+a.length,u.selectionEnd=g+a.length}else l(e,a,s.macroPosition,s.macroPosition+s.macroText.length)}},replaceTriggerText:function(e,t,n,r,i,a,s,m){c(e,t,n,r);var u=g(e,i,s,!0,m);if(void 0!==u)if(o()){var f=d(e).activeElement;a+=" ";var h=u.mentionPosition,p=u.mentionPosition+u.mentionText.length+1;f.value=f.value.substring(0,h)+a+f.value.substring(p,f.value.length),f.selectionStart=h+a.length,f.selectionEnd=h+a.length}else l(e,a+=" ",u.mentionPosition,u.mentionPosition+u.mentionText.length+1)},getMacroMatch:m,getTriggerInfo:g,selectElement:a,getTextAreaOrInputUnderlinePosition:T,getTextPrecedingCurrentSelection:h,getContentEditableSelectedPath:u,getNodePositionInParent:s,getContentEditableCaretPosition:p,pasteHtml:l,resetSelection:c,scrollIntoView:i}}]),angular.module("mentio").run(["$templateCache",function(e){e.put("mentio-menu.tpl.html",'<style>\n.scrollable-menu {\n    height: auto;\n    max-height: 300px;\n    overflow: auto;\n}\n\n.menu-highlighted {\n    font-weight: bold;\n}\n</style>\n<ul class="dropdown-menu scrollable-menu" style="display:block">\n    <li mentio-menu-item="item" ng-repeat="item in items track by $index">\n        <a class="text-primary" ng-bind-html="item.label | mentioHighlight:typedTerm:\'menu-highlighted\' | unsafe"></a>\n    </li>\n</ul>')}]);